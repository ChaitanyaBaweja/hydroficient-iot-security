# =============================================================================
# Mosquitto Configuration: mTLS SECURED (Project 5)
# =============================================================================
#
# This configuration requires MUTUAL TLS authentication:
# - Broker proves identity with server certificate
# - Clients prove identity with client certificates
# - All traffic encrypted with TLS 1.2+
#
# Before using this configuration:
# 1. Run generate_client_certs.py to create client certificates
# 2. Ensure certs/ folder contains:
#    - ca.pem, ca-key.pem (from Project 4)
#    - server.pem, server-key.pem (from Project 4)
#    - device-001.pem, device-001-key.pem (from this project)
#    - device-002.pem, device-002-key.pem (from this project)
#    - device-003.pem, device-003-key.pem (from this project)
#
# Start with: mosquitto -c mosquitto_mtls.conf -v
# =============================================================================

# -----------------------------------------------------------------------------
# Network Settings
# -----------------------------------------------------------------------------

# MQTT over TLS port (standard MQTTS port)
listener 8883

# Bind to localhost only (safer for testing)
bind_address localhost

# -----------------------------------------------------------------------------
# TLS Configuration
# -----------------------------------------------------------------------------

# Path to Certificate Authority certificate
# Used to verify BOTH server (by clients) and clients (by server)
cafile certs/ca.pem

# Path to server certificate
# This proves the broker's identity to clients
certfile certs/server.pem

# Path to server private key
# Keep this file secure - it's the broker's secret
keyfile certs/server-key.pem

# -----------------------------------------------------------------------------
# mTLS Settings (The Key Change from Project 4)
# -----------------------------------------------------------------------------

# REQUIRE clients to present a valid certificate
# This is THE setting that enables mTLS
# Without this: anyone with CA cert can connect (one-way TLS)
# With this: only devices with valid client certs can connect (mutual TLS)
require_certificate true

# Use the certificate's Common Name as the client username
# This means "HYDROLOGIC-MainBuilding-001" becomes the username
# Useful for access control and logging
use_identity_as_username true

# -----------------------------------------------------------------------------
# Security Settings
# -----------------------------------------------------------------------------

# Disable anonymous connections
# Combined with require_certificate, this ensures all clients are verified
allow_anonymous false

# -----------------------------------------------------------------------------
# Logging
# -----------------------------------------------------------------------------

# Log all events (useful for debugging)
log_type all

# Print logs to terminal
log_dest stdout

# =============================================================================
# What Changed from Project 4?
# =============================================================================
#
# Project 4 (mosquitto_tls.conf):
#   require_certificate false    # Clients don't need certificates
#   allow_anonymous true         # Anyone can connect
#
# Project 5 (this file):
#   require_certificate true     # Clients MUST present certificate
#   use_identity_as_username true # Device name from certificate
#   allow_anonymous false        # No anonymous connections
#
# =============================================================================
# Troubleshooting
# =============================================================================
#
# "Unable to load CA certificates"
#   -> Check the cafile path is correct
#   -> Make sure ca.pem exists in certs/ folder
#
# "peer did not return a certificate"
#   -> Client tried to connect without a certificate
#   -> This is mTLS working correctly! Client needs client cert.
#
# "certificate verify failed"
#   -> Client certificate wasn't signed by our CA
#   -> Or client is using a certificate from a different CA
#
# "Error loading server certificate"
#   -> Check the certfile path is correct
#   -> Make sure server.pem is a valid certificate
#
# "Address already in use"
#   -> Another Mosquitto is running on port 8883
#   -> Kill the other instance first (Ctrl+C in that terminal)
#
# =============================================================================
# End of configuration
# =============================================================================
